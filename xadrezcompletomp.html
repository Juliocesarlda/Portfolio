<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Xadrez Multiplayer - Firebase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { background:#000; color:#fff; font-family:Arial, sans-serif; text-align:center; margin:0; padding:16px; }
    #top { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    #tabuleiro { display:grid; grid-template-columns:repeat(8,1fr); width:90vmin; height:90vmin; max-width:420px; max-height:420px; margin:0 auto; border:3px solid #fff; }
    .casa { display:flex; align-items:center; justify-content:center; font-size:calc(90vmin/8 * .6); user-select:none; position:relative; }
    .branca{ background:#febe7e }
    .preta{ background:#713303 }
    .casa.selecionado{ outline:3px solid yellow }
    .casa.movimento-possivel::after {
      content: "";
      position: absolute;
      width: 20%;
      height: 20%;
      background: rgba(255, 255, 0, 0.6);
      border-radius: 50%;
      top: 40%;
      left: 40%;
    }
    .casa:hover{ filter:brightness(1.2); cursor:pointer }
    .peca-branca { color: #fff; }
    .peca-preta { color: #000; }
    .controls { display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap }
    button, input, textarea { padding:8px 10px; border-radius:6px; border:none; font-size:0.95rem; font-family: inherit; }
    .btn-primary{ background:#007bff; color:#fff }
    #info { background:#222; padding:12px; border-radius:8px; max-width:720px; margin:8px auto 18px auto; text-align:left }
    #room-ui { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap }
    #statusLine{ margin-top:8px; font-weight:600 }
    small { color:#ccc }
    
    /* --- NOVO: Responsivo celular */
    @media (max-width: 480px) {
      #tabuleiro { width: 95vmin; height: 95vmin; max-width: 95vw; max-height: 95vw; }
      .casa { font-size: calc(95vmin/8 * 0.5); }
    }
    
    /* --- NOVO: Chat box */
    #chat {
      max-width: 720px;
      margin: 0 auto 16px auto;
      background: #111;
      padding: 8px;
      border-radius: 8px;
      color: #eee;
      height: 180px;
      overflow-y: auto;
      font-size: 0.9rem;
      text-align: left;
    }
    #chat input[type="text"] {
      width: calc(100% - 80px);
      margin-right: 4px;
    }
    #chat button {
      width: 60px;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <h1>♟ Xadrez Multiplayer (Firebase) ♟</h1>

  <div id="info">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <strong>Como jogar:</strong> crie uma sala ou entre por ID. O primeiro a entrar vira <em>Brancas</em>, o segundo <em>Pretas</em>. Seus movimentos são sincronizados com o outro jogador.
      </div>
      <div id="meuIdLine"></div>
    </div>
    <div id="statusLine">Conectando...</div>
  </div>

  <div id="top" class="controls">
    <div id="room-ui">
      <button id="btn-create" class="btn-primary">Criar Sala</button>
      <input id="room-id" placeholder="ID da sala (opcional)" />
      <button id="btn-join">Entrar / Atualizar</button>
      <button id="btn-leave">Sair da Sala</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px; flex-wrap:wrap; justify-content:center;">
      <label>Seu apelido:</label>
      <input id="nickname" type="text" placeholder="Digite seu nome" style="width:120px" />
      <label style="margin-left:8px">Você é:</label>
      <span id="meuLado">—</span>
      <label style="margin-left:8px">Estado partida:</label>
      <span id="gameStatus">—</span>
    </div>
    <div>
      <button id="btn-reiniciar">Reiniciar (solicitar)</button>
    </div>
  </div>

  <div id="tabuleiro"></div>

  <!-- --- NOVO: Chat --->
  <div id="chat">
    <div id="chat-messages"></div>
    <input type="text" id="chat-input" placeholder="Digite mensagem..." />
    <button id="chat-send">Enviar</button>
  </div>


<script>
// ========= CONFIGURE AQUI =========
const firebaseConfig = {
  apiKey: "AIzaSyD3r1mxjMlqCVrGCAqYsfZoIRq6XJEcyw0",
  authDomain: "xadrezmultiplayer.firebaseapp.com",
  databaseURL: "https://xadrezmultiplayer-default-rtdb.firebaseio.com",
  projectId: "xadrezmultiplayer",
  storageBucket: "xadrezmultiplayer.appspot.com",
  messagingSenderId: "684250778641",
  appId: "1:684250778641:web:337f7be93d4d7f240875b0",
  measurementId: "G-HFENMEZ8BM"
};

if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.databaseURL) {
  document.getElementById('statusLine').innerText = '⚠️ configuração Firebase incompleta.';
}

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let pecasIniciais = [
  ["&#9814;","&#9816;","&#9815;","&#9813;","&#9812;","&#9815;","&#9816;","&#9814;"],
  ["&#9817;","&#9817;","&#9817;","&#9817;","&#9817;","&#9817;","&#9817;","&#9817;"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["&#9823;","&#9823;","&#9823;","&#9823;","&#9823;","&#9823;","&#9823;","&#9823;"],
  ["&#9820;","&#9822;","&#9821;","&#9819;","&#9818;","&#9821;","&#9822;","&#9820;"]
];

let pecas = JSON.parse(JSON.stringify(pecasIniciais));
let selecionado = null;
let vez = "branca";
let enPassant = null;
let roomId = null;
let meuId = localStorage.getItem('xadrez_meuId') || ('p_' + Math.floor(Math.random()*1e9));
localStorage.setItem('xadrez_meuId', meuId);
document.getElementById('meuIdLine').innerText = `ID: ${meuId}`;

let meuLado = null; // 'branca' | 'preta' | null

// --- NOVO: Apelido
let meuApelido = localStorage.getItem('xadrez_nickname') || '';
const inputNickname = document.getElementById('nickname');
inputNickname.value = meuApelido;
inputNickname.addEventListener('change', () => {
  meuApelido = inputNickname.value.trim() || meuId.slice(0,6);
  localStorage.setItem('xadrez_nickname', meuApelido);
  if(roomId) atualizarApelidoJogador();
});

const connectedRef = db.ref(".info/connected");

function atualizarApelidoJogador() {
  if (!roomId || !meuLado) return;
  const sideKey = meuLado === 'branca' ? 'white' : 'black';
  db.ref(`rooms/${roomId}/players/${sideKey}Name`).set(meuApelido);
}

// --- FUNÇÕES ORIGINAIS ---

function corDaPeca(simbolo) {
  if (!simbolo) return null;
  const code = Number(simbolo.replace(/[^\d]/g, ""));
  if (code >= 9812 && code <= 9817) return "branca";
  if (code >= 9818 && code <= 9823) return "preta";
  return null;
}
function caminhoLivre(orig, dest) {
  let dLinha = Math.sign(dest.linha - orig.linha);
  let dCol = Math.sign(dest.coluna - orig.coluna);
  let l = orig.linha + dLinha;
  let c = orig.coluna + dCol;
  while (l !== dest.linha || c !== dest.coluna) {
    if (pecas[l][c] !== "") return false;
    l += dLinha;
    c += dCol;
  }
  return true;
}
function movimentoValido(orig, dest) {
  const peca = pecas[orig.linha][orig.coluna];
  if (!peca) return false;
  const tipo = Number(peca.replace(/[^\d]/g, ""));
  const cor = corDaPeca(peca);
  const dLinha = dest.linha - orig.linha;
  const dCol = dest.coluna - orig.coluna;
  if (pecas[dest.linha][dest.coluna] !== "" && corDaPeca(pecas[dest.linha][dest.coluna]) === cor) return false;

  if (tipo === 9817 || tipo === 9823) {
    let dir = cor === "branca" ? 1 : -1;
    let linhaInicial = cor === "branca" ? 1 : 6;
    if (dCol === 0 && pecas[dest.linha][dest.coluna] === "") {
      if (dLinha === dir) return true;
      if (orig.linha === linhaInicial && dLinha === 2 * dir && pecas[orig.linha + dir][orig.coluna] === "") return true;
    }
    if (Math.abs(dCol) === 1 && dLinha === dir && pecas[dest.linha][dest.coluna] !== "" && corDaPeca(pecas[dest.linha][dest.coluna]) !== cor) {
      return true;
    }
    return false;
  }
  if (tipo === 9814 || tipo === 9820) return (dLinha === 0 || dCol === 0) && caminhoLivre(orig, dest);
  if (tipo === 9816 || tipo === 9822) return (Math.abs(dLinha) === 2 && Math.abs(dCol) === 1) || (Math.abs(dLinha) === 1 && Math.abs(dCol) === 2);
  if (tipo === 9815 || tipo === 9821) return Math.abs(dLinha) === Math.abs(dCol) && caminhoLivre(orig, dest);
  if (tipo === 9813 || tipo === 9819) return (dLinha === 0 || dCol === 0 || Math.abs(dLinha) === Math.abs(dCol)) && caminhoLivre(orig, dest);
  if (tipo === 9812 || tipo === 9818) {
    if (Math.abs(dLinha) <= 1 && Math.abs(dCol) <= 1) return true;
    if (Math.abs(dCol) === 2 && dLinha === 0) {
      let linha = orig.linha;
      if (dCol === 2 && pecas[linha][7] && (pecas[linha][7] === "&#9814;" || pecas[linha][7] === "&#9820;")) {
        if (pecas[linha][5] === "" && pecas[linha][6] === "") return true;
      }
      if (dCol === -2 && pecas[linha][0] && (pecas[linha][0] === "&#9814;" || pecas[linha][0] === "&#9820;")) {
        if (pecas[linha][1] === "" && pecas[linha][2] === "" && pecas[linha][3] === "") return true;
      }
    }
  }
  return false;
}
function encontrarRei(cor) {
  for (let linha=0; linha<8; linha++){
    for (let coluna=0; coluna<8; coluna++){
      const peca = pecas[linha][coluna];
      if (peca && corDaPeca(peca) === cor) {
        const tipo = Number(peca.replace(/[^\d]/g, ""));
        if ((cor === "branca" && tipo === 9812) || (cor === "preta" && tipo === 9818)) return {linha,coluna};
      }
    }
  }
  return null;
}
function estaEmXeque(cor) {
  const rei = encontrarRei(cor);
  if (!rei) return false;
  const corOponente = cor === "branca" ? "preta" : "branca";
  for (let linha=0; linha<8; linha++){
    for (let coluna=0; coluna<8; coluna++){
      const peca = pecas[linha][coluna];
      if (peca && corDaPeca(peca) === corOponente) {
        if (movimentoValido({linha,coluna}, rei)) return true;
      }
    }
  }
  return false;
}
function temMovimentosPossiveis(cor) {
  for (let linha=0; linha<8; linha++){
    for (let coluna=0; coluna<8; coluna++){
      const peca = pecas[linha][coluna];
      if (peca && corDaPeca(peca) === cor) {
        for (let l2=0; l2<8; l2++){
          for (let c2=0; c2<8; c2++){
            if ((linha!==l2 || coluna!==c2) && movimentoValido({linha,coluna},{linha:l2,coluna:c2})) {
              const backup = pecas[l2][c2];
              pecas[l2][c2] = peca;
              pecas[linha][coluna] = "";
              const emXeque = estaEmXeque(cor);
              pecas[linha][coluna] = peca;
              pecas[l2][c2] = backup;
              if (!emXeque) return true;
            }
          }
        }
      }
    }
  }
  return false;
}

const tabuleiroEl = document.getElementById('tabuleiro');

function desenharTabuleiro() {
  tabuleiroEl.innerHTML = '';
  for (let i=0;i<8;i++){
    for (let j=0;j<8;j++){
      const casa = document.createElement('div');
      casa.className = 'casa ' + ((i+j)%2===0 ? 'branca' : 'preta');
      casa.dataset.linha = i;
      casa.dataset.coluna = j;
      const s = pecas[i][j];
      if (s) {
        const span = document.createElement('span');
        span.innerHTML = s;
        span.className = corDaPeca(s) === 'branca' ? 'peca-branca' : 'peca-preta';
        casa.appendChild(span);
      }
      casa.addEventListener('click', selecionarOuMover);
      if (selecionado && selecionado.linha === i && selecionado.coluna === j) {
        casa.classList.add('selecionado');
      }
      tabuleiroEl.appendChild(casa);
    }
  }
  if (selecionado) destacarMovimentosPossiveis(selecionado);
}

function destacarMovimentosPossiveis(origem) {
  for (let l=0; l<8; l++) {
    for (let c=0; c<8; c++) {
      if (movimentoValido(origem, {linha:l, coluna:c})) {
        const casa = tabuleiroEl.querySelector(`.casa[data-linha="${l}"][data-coluna="${c}"]`);
        if (casa) casa.classList.add('movimento-possivel');
      }
    }
  }
}

function limparDestaques() {
  tabuleiroEl.querySelectorAll('.casa').forEach(casa => casa.classList.remove('movimento-possivel'));
}

function selecionarOuMover(event) {
  if (!meuLado) return alert('Entre em uma sala para jogar.');
  if (vez !== meuLado) return alert('Não é sua vez.');
  const linha = Number(event.currentTarget.dataset.linha);
  const coluna = Number(event.currentTarget.dataset.coluna);
  if (selecionado) {
    if (selecionado.linha === linha && selecionado.coluna === coluna) {
      selecionado = null;
      limparDestaques();
      desenharTabuleiro();
      return;
    }
    // valida movimento
    if (movimentoValido(selecionado, {linha,coluna})) {
      // Simular movimento para checar xeque
      const pecaOrig = pecas[selecionado.linha][selecionado.coluna];
      const pecaDest = pecas[linha][coluna];
      pecas[linha][coluna] = pecaOrig;
      pecas[selecionado.linha][selecionado.coluna] = "";
      if (estaEmXeque(meuLado)) {
        alert('Movimento inválido: você ficaria em xeque!');
        // Reverter
        pecas[selecionado.linha][selecionado.coluna] = pecaOrig;
        pecas[linha][coluna] = pecaDest;
        return;
      }
      // Movimento válido, atualizar no Firebase
      atualizarTabuleiroNoFirebase(pecas);
      selecionado = null;
      limparDestaques();
      return;
    } else {
      alert('Movimento inválido!');
    }
  } else {
    if (pecas[linha][coluna] && corDaPeca(pecas[linha][coluna]) === meuLado) {
      selecionado = {linha, coluna};
      limparDestaques();
      desenharTabuleiro();
    }
  }
}

function atualizarTabuleiroNoFirebase(pecasAtuais) {
  if (!roomId) return;
  db.ref(`rooms/${roomId}/board`).set({
    pecas: pecasAtuais,
    vez: vez === 'branca' ? 'preta' : 'branca',
    lastMove: { // simples
      from: selecionado,
      to: null
    }
  });
}

// --- Gerenciamento sala ---

function criarSala() {
  const newRoomId = Math.random().toString(36).substr(2, 6);
  db.ref(`rooms/${newRoomId}`).set({
    board: { pecas: pecasIniciais, vez: 'branca' },
    players: {},
    chat: {}
  });
  roomId = newRoomId;
  conectarSala();
}

function conectarSala() {
  if (!roomId) return;
  document.getElementById('statusLine').innerText = `Conectado à sala ${roomId}`;
  db.ref(`rooms/${roomId}/players`).once('value').then(snapshot => {
    const players = snapshot.val() || {};
    // Adicionar jogador se faltar
    if (!players.white) {
      meuLado = 'branca';
      db.ref(`rooms/${roomId}/players/white`).set(meuId);
      atualizarApelidoJogador();
    } else if (!players.black && players.white !== meuId) {
      meuLado = 'preta';
      db.ref(`rooms/${roomId}/players/black`).set(meuId);
      atualizarApelidoJogador();
    } else if (players.white === meuId) {
      meuLado = 'branca';
    } else if (players.black === meuId) {
      meuLado = 'preta';
    } else {
      alert('Sala cheia!');
      meuLado = null;
      return;
    }
    document.getElementById('meuLado').innerText = meuLado === 'branca' ? 'Brancas' : 'Pretas';
    escutarSala();
  }).catch(console.error);
}

function escutarSala() {
  if (!roomId) return;
  const salaRef = db.ref(`rooms/${roomId}`);
  salaRef.on('value', snapshot => {
    const data = snapshot.val();
    if (!data) {
      alert('Sala fechada.');
      resetarJogo();
      return;
    }
    // Atualiza jogadores
    const players = data.players || {};
    document.getElementById('statusLine').innerText = `Sala: ${roomId} | Jogadores: Branco: ${players.white ? players.white.slice(0,6) : '-'} / Preto: ${players.black ? players.black.slice(0,6) : '-'}`;
    // Atualiza apelidos
    const whiteName = data.players?.whiteName || players.white?.slice(0,6) || '-';
    const blackName = data.players?.blackName || players.black?.slice(0,6) || '-';

    // Atualizar apelidos visuais (pode expandir)
    // Atualizar vez
    vez = data.board?.vez || 'branca';
    pecas = data.board?.pecas || JSON.parse(JSON.stringify(pecasIniciais));

    desenharTabuleiro();

    // Atualiza status partida
    let statusTxt = '';
    if (estaEmXeque(vez)) {
      statusTxt = `Xeque nas ${vez === 'branca' ? 'Brancas' : 'Pretas'}!`;
    }
    if (!temMovimentosPossiveis(vez)) {
      statusTxt = `Xeque-mate! ${vez === 'branca' ? 'Pretas' : 'Brancas'} venceu!`;
    }
    document.getElementById('gameStatus').innerText = statusTxt || 'Jogando';

    // Avisar se adversário desconectou (simples)
    if (meuLado) {
      const meuSideKey = meuLado === 'branca' ? 'white' : 'black';
      const outroSideKey = meuSideKey === 'white' ? 'black' : 'white';
      const outroJogador = players[outroSideKey];
      if (!outroJogador) {
        document.getElementById('statusLine').innerText += " | Aguardando adversário...";
      }
    }
  });
}

// --- NOVO: Chat ---

const chatRef = () => roomId ? db.ref(`rooms/${roomId}/chat`) : null;
const chatMessagesEl = document.getElementById('chat-messages');
const chatInputEl = document.getElementById('chat-input');
const chatSendBtn = document.getElementById('chat-send');

chatSendBtn.onclick = () => {
  const msg = chatInputEl.value.trim();
  if (!msg || !roomId || !meuApelido) return;
  const now = Date.now();
  chatRef().push({
    from: meuApelido,
    text: msg,
    time: now
  });
  chatInputEl.value = '';
};

function exibirMensagem(msg) {
  const el = document.createElement('div');
  const hora = new Date(msg.time).toLocaleTimeString();
  el.innerHTML = `<small>[${hora}]</small> <b>${msg.from}:</b> ${msg.text}`;
  chatMessagesEl.appendChild(el);
  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
}

function escutarChat() {
  if (!chatRef()) return;
  chatRef().off();
  chatRef().limitToLast(50).on('child_added', snapshot => {
    exibirMensagem(snapshot.val());
  });
}

// --- Eventos botões ---

document.getElementById('btn-create').onclick = () => {
  criarSala();
  escutarChat();
};

document.getElementById('btn-join').onclick = () => {
  const id = document.getElementById('room-id').value.trim();
  if (!id) return alert('Digite um ID de sala.');
  roomId = id;
  conectarSala();
  escutarChat();
};

document.getElementById('btn-leave').onclick = () => {
  if (!roomId) return alert('Você não está em nenhuma sala.');
  db.ref(`rooms/${roomId}/players`).once('value').then(snapshot => {
    const players = snapshot.val() || {};
    if (meuLado === 'branca') db.ref(`rooms/${roomId}/players/white`).remove();
    else if (meuLado === 'preta') db.ref(`rooms/${roomId}/players/black`).remove();
    roomId = null;
    meuLado = null;
    pecas = JSON.parse(JSON.stringify(pecasIniciais));
    vez = 'branca';
    selecionado = null;
    desenharTabuleiro();
    document.getElementById('statusLine').innerText = 'Você saiu da sala.';
    document.getElementById('meuLado').innerText = '—';
    document.getElementById('gameStatus').innerText = '—';
    chatMessagesEl.innerHTML = '';
  });
};

document.getElementById('btn-reiniciar').onclick = () => {
  if (!roomId) return alert('Entre em uma sala para reiniciar.');
  if (confirm('Solicitar reinício da partida?')) {
    db.ref(`rooms/${roomId}/restartRequest/${meuId}`).set(true);
  }
};

let restartListener = null;
function escutarReiniciar() {
  if (!roomId) return;
  if (restartListener) restartListener.off();
  restartListener = db.ref(`rooms/${roomId}/restartRequest`);
  restartListener.on('value', snapshot => {
    const pedidos = snapshot.val() || {};
    const keys = Object.keys(pedidos);
    if (keys.length >= 2) {
      // Ambos concordaram
      db.ref(`rooms/${roomId}/restartRequest`).remove();
      db.ref(`rooms/${roomId}/board`).set({
        pecas: pecasIniciais,
        vez: 'branca'
      });
      alert('Partida reiniciada!');
    }
  });
}

// Atualizar apelido do jogador quando muda input
inputNickname.addEventListener('change', () => {
  atualizarApelidoJogador();
});

// Inicializar
desenharTabuleiro();

</script>
</body>
</html>
