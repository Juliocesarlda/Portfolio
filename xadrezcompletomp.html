<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Xadrez Multiplayer - Firebase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { background:#000; color:#fff; font-family:Arial, sans-serif; text-align:center; margin:0; padding:16px; }
    #top { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    #tabuleiro { display:grid; grid-template-columns:repeat(8,1fr); width:90vmin; height:90vmin; max-width:420px; max-height:420px; margin:0 auto; border:3px solid #fff; }
    .casa { display:flex; align-items:center; justify-content:center; font-size:calc(90vmin/8 * .6); user-select:none; }
    .branca{ background:#febe7e } .preta{ background:#713303 }
    .casa.selecionado{ outline:3px solid yellow }
    .casa:hover{ filter:brightness(1.2); cursor:pointer }
    .controls { display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap }
    button, input { padding:8px 10px; border-radius:6px; border:none; font-size:0.95rem }
    .btn-primary{ background:#007bff; color:#fff }
    #info { background:#222; padding:12px; border-radius:8px; max-width:720px; margin:8px auto 18px auto; text-align:left }
    #room-ui { display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap }
    #statusLine{ margin-top:8px; font-weight:600 }
    small { color:#ccc }
  </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <h1>♟ Xadrez Multiplayer (Firebase) ♟</h1>

  <div id="info">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <strong>Como jogar:</strong> crie uma sala ou entre por ID. O primeiro a entrar vira <em>Brancas</em>, o segundo <em>Pretas</em>. Seus movimentos são sincronizados com o outro jogador.
      </div>
      <div id="meuIdLine"></div>
    </div>
    <div id="statusLine">Conectando...</div>
  </div>

  <div id="top" class="controls">
    <div id="room-ui">
      <button id="btn-create" class="btn-primary">Criar Sala</button>
      <input id="room-id" placeholder="ID da sala (opcional)" />
      <button id="btn-join">Entrar / Atualizar</button>
      <button id="btn-leave">Sair da Sala</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <label>Você é:</label>
      <span id="meuLado">—</span>
      <label style="margin-left:8px">Estado partida:</label>
      <span id="gameStatus">—</span>
    </div>
    <div>
      <button id="btn-reiniciar">Reiniciar (solicitar)</button>
    </div>
  </div>

  <div id="tabuleiro"></div>


<script>
// ========= CONFIGURE AQUI =========
const firebaseConfig = {
  apiKey: "AIzaSyD3r1mxjMlqCVrGCAqYsfZoIRq6XJEcyw0",
  authDomain: "xadrezmultiplayer.firebaseapp.com",
  databaseURL: "https://xadrezmultiplayer-default-rtdb.firebaseio.com",
  projectId: "xadrezmultiplayer",
  storageBucket: "xadrezmultiplayer.appspot.com",
  messagingSenderId: "684250778641",
  appId: "1:684250778641:web:337f7be93d4d7f240875b0",
  measurementId: "G-HFENMEZ8BM"
};

if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.databaseURL) {
  document.getElementById('statusLine').innerText = '⚠️ configuração Firebase incompleta.';
}

// Inicializa Firebase (v8 namespaced)
firebase.initializeApp(firebaseConfig);
const db = firebase.database();


/* --- resto do jogo (idêntico ao código funcional anterior) --- */
let pecasIniciais = [
  ["&#9814;","&#9816;","&#9815;","&#9813;","&#9812;","&#9815;","&#9816;","&#9814;"],
  ["&#9817;","&#9817;","&#9817;","&#9817;","&#9817;","&#9817;","&#9817;","&#9817;"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["&#9823;","&#9823;","&#9823;","&#9823;","&#9823;","&#9823;","&#9823;","&#9823;"],
  ["&#9820;","&#9822;","&#9821;","&#9819;","&#9818;","&#9821;","&#9822;","&#9820;"]
];

let pecas = JSON.parse(JSON.stringify(pecasIniciais));
let selecionado = null;
let vez = "branca";
let enPassant = null;
let roomId = null;
let meuId = localStorage.getItem('xadrez_meuId') || ('p_' + Math.floor(Math.random()*1e9));
localStorage.setItem('xadrez_meuId', meuId);
document.getElementById('meuIdLine').innerText = `ID: ${meuId}`;

let meuLado = null; // 'branca' | 'preta' | null
let connectedRef = db.ref(".info/connected");

function corDaPeca(simbolo) {
  if (!simbolo) return null;
  const code = Number(simbolo.replace(/[^\d]/g, ""));
  if (code >= 9812 && code <= 9817) return "branca";
  if (code >= 9818 && code <= 9823) return "preta";
  return null;
}
function caminhoLivre(orig, dest) {
  let dLinha = Math.sign(dest.linha - orig.linha);
  let dCol = Math.sign(dest.coluna - orig.coluna);
  let l = orig.linha + dLinha;
  let c = orig.coluna + dCol;
  while (l !== dest.linha || c !== dest.coluna) {
    if (pecas[l][c] !== "") return false;
    l += dLinha;
    c += dCol;
  }
  return true;
}
function movimentoValido(orig, dest) {
  const peca = pecas[orig.linha][orig.coluna];
  if (!peca) return false;
  const tipo = Number(peca.replace(/[^\d]/g, ""));
  const cor = corDaPeca(peca);
  const dLinha = dest.linha - orig.linha;
  const dCol = dest.coluna - orig.coluna;
  if (pecas[dest.linha][dest.coluna] !== "" && corDaPeca(pecas[dest.linha][dest.coluna]) === cor) return false;

  if (tipo === 9817 || tipo === 9823) {
    let dir = cor === "branca" ? 1 : -1;
    let linhaInicial = cor === "branca" ? 1 : 6;
    if (dCol === 0 && pecas[dest.linha][dest.coluna] === "") {
      if (dLinha === dir) return true;
      if (orig.linha === linhaInicial && dLinha === 2 * dir && pecas[orig.linha + dir][orig.coluna] === "") return true;
    }
    if (Math.abs(dCol) === 1 && dLinha === dir && pecas[dest.linha][dest.coluna] !== "" && corDaPeca(pecas[dest.linha][dest.coluna]) !== cor) {
      return true;
    }
    return false;
  }
  if (tipo === 9814 || tipo === 9820) return (dLinha === 0 || dCol === 0) && caminhoLivre(orig, dest);
  if (tipo === 9816 || tipo === 9822) return (Math.abs(dLinha) === 2 && Math.abs(dCol) === 1) || (Math.abs(dLinha) === 1 && Math.abs(dCol) === 2);
  if (tipo === 9815 || tipo === 9821) return Math.abs(dLinha) === Math.abs(dCol) && caminhoLivre(orig, dest);
  if (tipo === 9813 || tipo === 9819) return (dLinha === 0 || dCol === 0 || Math.abs(dLinha) === Math.abs(dCol)) && caminhoLivre(orig, dest);
  if (tipo === 9812 || tipo === 9818) {
    if (Math.abs(dLinha) <= 1 && Math.abs(dCol) <= 1) return true;
    if (Math.abs(dCol) === 2 && dLinha === 0) {
      let linha = orig.linha;
      if (dCol === 2 && pecas[linha][7] && (pecas[linha][7] === "&#9814;" || pecas[linha][7] === "&#9820;")) {
        if (pecas[linha][5] === "" && pecas[linha][6] === "") return true;
      }
      if (dCol === -2 && pecas[linha][0] && (pecas[linha][0] === "&#9814;" || pecas[linha][0] === "&#9820;")) {
        if (pecas[linha][1] === "" && pecas[linha][2] === "" && pecas[linha][3] === "") return true;
      }
    }
  }
  return false;
}
function encontrarRei(cor) {
  for (let linha=0; linha<8; linha++){
    for (let coluna=0; coluna<8; coluna++){
      const peca = pecas[linha][coluna];
      if (peca && corDaPeca(peca) === cor) {
        const tipo = Number(peca.replace(/[^\d]/g, ""));
        if ((cor === "branca" && tipo === 9812) || (cor === "preta" && tipo === 9818)) return {linha,coluna};
      }
    }
  }
  return null;
}
function estaEmXeque(cor) {
  const rei = encontrarRei(cor);
  if (!rei) return false;
  const corOponente = cor === "branca" ? "preta" : "branca";
  for (let linha=0; linha<8; linha++){
    for (let coluna=0; coluna<8; coluna++){
      const peca = pecas[linha][coluna];
      if (peca && corDaPeca(peca) === corOponente) {
        if (movimentoValido({linha,coluna}, rei)) return true;
      }
    }
  }
  return false;
}
function temMovimentosPossiveis(cor) {
  for (let linha=0; linha<8; linha++){
    for (let coluna=0; coluna<8; coluna++){
      const peca = pecas[linha][coluna];
      if (peca && corDaPeca(peca) === cor) {
        for (let l2=0; l2<8; l2++){
          for (let c2=0; c2<8; c2++){
            if ((linha!==l2 || coluna!==c2) && movimentoValido({linha,coluna},{linha:l2,coluna:c2})) {
              const backup = pecas[l2][c2];
              pecas[l2][c2] = peca;
              pecas[linha][coluna] = "";
              const emXeque = estaEmXeque(cor);
              pecas[linha][coluna] = peca;
              pecas[l2][c2] = backup;
              if (!emXeque) return true;
            }
          }
        }
      }
    }
  }
  return false;
}

const tabuleiroEl = document.getElementById('tabuleiro');
function desenharTabuleiro() {
  tabuleiroEl.innerHTML = '';
  for (let i=0;i<8;i++){
    for (let j=0;j<8;j++){
      const casa = document.createElement('div');
      casa.className = 'casa ' + ((i+j)%2===0 ? 'branca' : 'preta');
      casa.dataset.linha = i;
      casa.dataset.coluna = j;
      const s = pecas[i][j];
      if (s) {
        const span = document.createElement('span');
        span.innerHTML = s;
        span.className = corDaPeca(s) === 'branca' ? 'peca-branca' : 'peca-preta';
        casa.appendChild(span);
      }
      casa.addEventListener('click', selecionarOuMover);
      tabuleiroEl.appendChild(casa);
    }
  }
}
function atualizarStatusLinha() {
  document.getElementById('meuLado').innerText = meuLado ? (meuLado === 'branca' ? 'Brancas' : 'Pretas') : '—';
  document.getElementById('gameStatus').innerText = vez ? `Vez: ${vez}` : '—';
}

function criarSala() {
  const id = Math.random().toString(36).slice(2,8).toUpperCase();
  document.getElementById('room-id').value = id;
  entrarSala(id);
}

function entrarSala(id) {
  if (!id) {
    alert('Informe um ID de sala ou clique em Criar Sala');
    return;
  }
  if (roomId === id) return;
  sairSala();
  roomId = id;
  const roomRef = db.ref('rooms/' + roomId);
  roomRef.child('state').transaction(current => {
    if (current === null) {
      return {
        pecas: pecasIniciais,
        vez: 'branca',
        enPassant: null,
        status: 'playing',
        lastMove: null
      };
    }
    return current;
  }, (err, committed, snapshot) => {
    roomRef.child('players').transaction(players => {
      if (!players) {
        return { white: meuId, black: null };
      }
      if (players.white === meuId || players.black === meuId) return players;
      if (!players.white) { players.white = meuId; return players; }
      if (!players.black) { players.black = meuId; return players; }
      return players;
    }, (err2, committed2, snapPlayers) => {
      const players = snapPlayers.val();
      if (players && players.white === meuId) meuLado = 'branca';
      else if (players && players.black === meuId) meuLado = 'preta';
      else { alert('Sala cheia. Você entrou apenas como espectador.'); meuLado = null; }
      atualizarStatusLinha();
      if (meuLado) {
        const sideKey = (meuLado === 'branca' ? 'white' : 'black');
        roomRef.child('players/' + sideKey).onDisconnect().set(null);
      }
      roomRef.child('state').on('value', snap => {
        const s = snap.val();
        if (!s) return;
        pecas = s.pecas;
        vez = s.vez;
        enPassant = s.enPassant || null;
        document.getElementById('gameStatus').innerText = s.status || 'playing';
        desenharTabuleiro();
        atualizarStatusLinha();
      });
      roomRef.child('players').on('value', pSnap => {
        const p = pSnap.val() || {};
        const desc = `white:${p.white ? p.white.slice(0,6) : '-'} black:${p.black ? p.black.slice(0,6) : '-'}`;
        document.getElementById('statusLine').innerText = `Sala ${roomId} — ${desc}`;
      });
    });
  });
}

function sairSala() {
  if (!roomId) return;
  const roomRef = db.ref('rooms/' + roomId);
  roomRef.child('state').off();
  roomRef.child('players').off();
  if (meuLado) {
    const sideKey = meuLado === 'branca' ? 'white' : 'black';
    roomRef.child('players/' + sideKey).transaction(cur => {
      if (!cur) return null;
      if (cur === meuId) return null;
      return cur;
    });
  }
  roomId = null;
  meuLado = null;
  document.getElementById('statusLine').innerText = 'Desconectado da sala';
  atualizarStatusLinha();
}

function solicitarMovimentoServidor(novoEstado) {
  if (!roomId) {
    applyLocalState(novoEstado);
    return;
  }
  const stateRef = db.ref('rooms/' + roomId + '/state');
  stateRef.transaction(current => {
    if (!current) return novoEstado;
    if (current.vez === novoEstado.vez) {
      // Moveu na vez do outro, não faz nada
      return;
    }
    return novoEstado;
  }, (err, committed, snap) => {
    if (err) { console.error('Erro transação:', err); alert('Erro ao enviar movimento.'); }
  });
}

function applyLocalState(novo) {
  pecas = novo.pecas;
  vez = novo.vez;
  enPassant = novo.enPassant;
  document.getElementById('gameStatus').innerText = novo.status || 'playing';
  desenharTabuleiro();
  atualizarStatusLinha();
}

function selecionarOuMover(event) {
  if (roomId && meuLado && vez !== meuLado) return;
  const casa = event.currentTarget;
  const linha = parseInt(casa.dataset.linha);
  const coluna = parseInt(casa.dataset.coluna);

  if (selecionado) {
    const destino = { linha, coluna };
    const pecaMovida = pecas[selecionado.linha][selecionado.coluna];
    const tipo = Number(pecaMovida.replace(/[^\d]/g, ""));
    const cor = corDaPeca(pecaMovida);

    let enPassantCaptura = false;
    if (enPassant && (tipo === 9817 || tipo === 9823)) {
      if (linha === enPassant.linha && coluna === enPassant.coluna) {
        if (Math.abs(coluna - selecionado.coluna) === 1 && ((cor === "branca" && linha - selecionado.linha === 1) || (cor === "preta" && linha - selecionado.linha === -1))) {
          enPassantCaptura = true;
        }
      }
    }

    if (movimentoValido(selecionado, destino) || enPassantCaptura) {
      const backup = pecas[linha][coluna];
      pecas[linha][coluna] = pecaMovida;
      pecas[selecionado.linha][selecionado.coluna] = "";

      if (enPassantCaptura) {
        if (cor === "branca") pecas[linha - 1][coluna] = "";
        else pecas[linha + 1][coluna] = "";
      }

      for (let col = 0; col < 8; col++) {
        if (pecas[7][col] === "&#9817;") pecas[7][col] = "&#9813;";
        if (pecas[0][col] === "&#9823;") pecas[0][col] = "&#9819;";
      }

      if ((pecas[linha][coluna] === "&#9812;" || pecas[linha][coluna] === "&#9818;") && Math.abs(coluna - selecionado.coluna) === 2) {
        if (coluna === 6) { pecas[linha][5] = pecas[linha][7]; pecas[linha][7] = ""; }
        if (coluna === 2) { pecas[linha][3] = pecas[linha][0]; pecas[linha][0] = ""; }
      }

      const prevEnPassant = enPassant;
      enPassant = null;
      if (tipo === 9817 || tipo === 9823) {
        if (Math.abs(linha - selecionado.linha) === 2) {
          enPassant = { linha: (linha + selecionado.linha) / 2, coluna: coluna };
        }
      }

      const backupOrig = pecas[selecionado.linha][selecionado.coluna];
      const backupDest = backup;
      if (estaEmXeque(cor)) {
        pecas[selecionado.linha][selecionado.coluna] = backupOrig;
        pecas[linha][coluna] = backupDest;
        if (enPassantCaptura) {
          if (cor === "branca") pecas[linha - 1][coluna] = "&#9823;"; else pecas[linha + 1][coluna] = "&#9817;";
        }
        enPassant = prevEnPassant;
        alert("Movimento ilegal: seu rei ficaria em xeque!");
      } else {
        vez = vez === "branca" ? "preta" : "branca";
        const novoEstado = {
          pecas: pecas,
          vez: vez,
          enPassant: enPassant,
          status: 'playing',
          lastMove: { from: selecionado, to: { linha, coluna }, by: meuId }
        };
        solicitarMovimentoServidor(novoEstado);
        setTimeout(() => {
          if (estaEmXeque(vez) && !temMovimentosPossiveis(vez)) {
            alert(vez === "preta" ? "Xeque-mate! As Brancas venceram!" : "Xeque-mate! As Pretas venceram!");
            vez = "fim";
          } else if (!temMovimentosPossiveis(vez)) {
            alert("Empate! Nenhum movimento possível.");
            vez = "fim";
          }
        }, 100);
      }
    }
    selecionado = null;
    desenharTabuleiro();
  } else if (pecas[linha][coluna] && corDaPeca(pecas[linha][coluna]) === vez) {
    selecionado = { linha, coluna };
    desenharTabuleiro(); // Redesenha para limpar a seleção anterior
    casa.classList.add('selecionado');
  }
}


function reiniciarPartida() {
  if (!roomId) {
    alert('Você não está em uma sala.');
    return;
  }
  if (meuLado !== 'branca' && meuLado !== 'preta') {
    alert('Você deve ser um jogador para reiniciar a partida.');
    return;
  }

  const confirm = window.confirm("Tem certeza que deseja reiniciar a partida? Isso irá apagar todo o progresso.");
  if (!confirm) return;

  const roomRef = db.ref('rooms/' + roomId + '/state');
  roomRef.transaction(currentState => {
    if (currentState) {
      return {
        pecas: pecasIniciais,
        vez: 'branca',
        enPassant: null,
        status: 'playing',
        lastMove: null
      };
    }
    return currentState;
  }, (error, committed, snapshot) => {
    if (error) {
      console.error("Transação de reinício falhou: ", error);
      alert("Erro ao tentar reiniciar a partida.");
    } else if (committed) {
      alert("Partida reiniciada com sucesso!");
    }
  });
}


document.getElementById('btn-create').addEventListener('click', criarSala);
document.getElementById('btn-join').addEventListener('click', () => {
  const id = document.getElementById('room-id').value;
  entrarSala(id);
});
document.getElementById('btn-leave').addEventListener('click', sairSala);
document.getElementById('btn-reiniciar').addEventListener('click', reiniciarPartida);

connectedRef.on("value", function(snap) {
  if (snap.val() === true) {
    document.getElementById('statusLine').innerText = 'Online';
  } else {
    document.getElementById('statusLine').innerText = 'Desconectado';
  }
});

// Inicialização
desenharTabuleiro();
atualizarStatusLinha();
</script>
</body>
</html>